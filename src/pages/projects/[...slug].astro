---
import { type CollectionEntry, getCollection } from "astro:content";
import PageLayout from "@layouts/PageLayout.astro";
import Container from "@components/Container.astro";
import FormattedDate from "@components/FormattedDate.astro";
import { readingTime } from "@lib/utils";
import BackToPrev from "@components/BackToPrev.astro";
import Link from "@components/Link.astro";
import PhotoViewer from "@components/PhotoViewer.astro";

export async function getStaticPaths() {
  const projects = (await getCollection("projects"))
    .filter(post => !post.data.draft)
    .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
  return projects.map((project) => ({
    params: { slug: project.slug },
    props: project,
  }));
}
type Props = CollectionEntry<"projects">;

const project = Astro.props;
const { Content } = await project.render();
---

<PageLayout title={project.data.title} description={project.data.description}>
  <Container>
    <div class="animate">
      <BackToPrev href="/projects">
        Back to projects
      </BackToPrev>
    </div>
    <div class="space-y-1 my-10">
      <div class="animate flex items-center gap-1.5">
        <div class="font-base text-sm">
          <FormattedDate date={project.data.date} />
        </div>
        &bull;
        <div class="font-base text-sm">
          {readingTime(project.body)}
        </div>
      </div>
      <div class="animate text-2xl font-semibold text-black dark:text-white">
        {project.data.title}
      </div>
      {(project.data.demoURL || project.data.repoURL) && (
        <nav class="animate flex gap-1">
          {project.data.demoURL && (
            <Link href={project.data.demoURL} external>
              demo
            </Link>
          )}
          {project.data.demoURL && project.data.repoURL && (
            <span>/</span>
          )}
          {project.data.repoURL && (
            <Link href={project.data.repoURL} external>
              repo
            </Link>
          )}
        </nav>
      )}
    </div>
    <article class="animate">
      <Content />
    </article>

    <!-- Photo Viewer Component -->
    <PhotoViewer />

    <script define:vars={{ projectSlug: project.slug }}>
      function setupProjectPhotoViewer() {
        // Find all images in the article content
        const articleImages = document.querySelectorAll('article img');
        
        if (articleImages.length === 0) return;

        console.log(`Found ${articleImages.length} images in project: ${projectSlug}`);

        // Convert images to Photo objects
        const photos = Array.from(articleImages).map((img, index) => ({
          url: img.src,
          alt: img.alt || `Image ${index + 1}`
        }));

        // Add click handlers to images
        articleImages.forEach((img, index) => {
          // Wrap image in a clickable container if not already wrapped
          if (img.parentElement?.tagName !== 'BUTTON') {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'photo-item cursor-pointer focus:outline-none focus:ring-2 focus:ring-black/20 dark:focus:ring-white/30 rounded-lg group block w-full';
            button.setAttribute('data-photo-index', index.toString());
            button.setAttribute('aria-label', `View image: ${img.alt || `Image ${index + 1}`}`);
            
            // Replace img with button containing img
            img.parentNode?.insertBefore(button, img);
            button.appendChild(img);
            
            // Add hover effect to img
            img.className = `${img.className} group-hover:scale-[1.02] transition-transform duration-300`.trim();
          }

          // Add click handler
          const clickHandler = (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            console.log(`Project image clicked: ${index} from project: ${projectSlug}`);
            
            if (window.openPhotoViewer && photos && photos.length > 0) {
              window.openPhotoViewer(photos, index);
            } else {
              console.error('PhotoViewer not available or no photos:', {
                viewerAvailable: !!window.openPhotoViewer,
                photosCount: photos ? photos.length : 0
              });
            }
          };

          const keyHandler = (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              clickHandler(e);
            }
          };

          const button = img.closest('button') || img;
          button.addEventListener('click', clickHandler);
          button.addEventListener('keydown', keyHandler);
        });
      }

      function initProjectPhotoViewer() {
        if (window.photoViewerReady) {
          console.log('PhotoViewer ready, setting up project images for:', projectSlug);
          setupProjectPhotoViewer();
        } else {
          console.log('Waiting for PhotoViewer to be ready...');
          document.addEventListener('photoViewerReady', setupProjectPhotoViewer);
        }
      }

      // Cleanup any previous handlers
      document.removeEventListener('photoViewerReady', setupProjectPhotoViewer);

      // Initialize
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initProjectPhotoViewer);
      } else {
        initProjectPhotoViewer();
      }

      // Handle Astro page transitions
      document.addEventListener('astro:page-load', initProjectPhotoViewer);
    </script>
  </Container>
</PageLayout>